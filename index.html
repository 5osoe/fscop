<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>فونت سكوب | Font Scope Pro</title>
    <meta name="description" content="Professional Font Manager - Optimized.">
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Analytics (Preserved) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X0B0V3X07Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-X0B0V3X07Z');
    </script>

    <!-- Resources -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- 1. Clean Design Tokens (Apple-Like) --- */
        :root {
            /* Light Mode - Softer, warmer grays */
            --bg-body: #F5F7FA;
            --bg-surface: #FFFFFF;
            --bg-subtle: #F0F2F5;
            
            --border-light: #E2E4E8;
            --border-hover: #CBD5E1;
            
            --text-primary: #1F2937;
            --text-secondary: #64748B;
            --text-tertiary: #94A3B8;
            
            --accent: #111827;
            --accent-hover: #374151;
            --danger: #EF4444;

            /* Metrics */
            --sidebar-w: 280px;
            --header-h: 80px;
            --control-h: 44px; /* Unifying Height */
            --radius-xl: 16px;
            --radius-lg: 12px;
            --radius-md: 8px;
            
            /* Shadows - Soft & Professional */
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.04);
            --shadow-card-hover: 0 12px 28px rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            
            --transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        [data-theme="dark"] {
            /* Dark Mode - Deep gray, avoid pure black */
            --bg-body: #0F1115; /* Deep rich dark */
            --bg-surface: #181A20;
            --bg-subtle: #23262E;
            
            --border-light: #2A2D35;
            --border-hover: #3E434D;
            
            --text-primary: #EAEAEA; /* Soft White */
            --text-secondary: #A0A0A0;
            --text-tertiary: #606060;
            
            --accent: #FFFFFF;
            --accent-hover: #E0E0E0;
            
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-card-hover: 0 12px 28px rgba(0, 0, 0, 0.5);
        }

        /* --- 2. Reset & Typography --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Prevent Font Inheritance on Previews */
        .card-preview { font-family: initial; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

        /* --- 3. Layout --- */
        .app-shell {
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            width: 100%;
            height: 100%;
        }

        /* --- 4. Sidebar (Refined) --- */
        .sidebar {
            background: var(--bg-surface);
            border-left: 1px solid var(--border-light);
            display: flex; flex-direction: column;
            padding: 2rem 1.5rem;
            gap: 1.5rem;
            z-index: 50;
            overflow-y: auto;
        }

        .brand {
            display: flex; align-items: center; gap: 0.75rem;
            font-weight: 700; font-size: 1.1rem; color: var(--text-primary);
            text-decoration: none; user-select: none;
            padding-bottom: 0.5rem;
        }
        .brand-icon {
            width: 32px; height: 32px; background: var(--accent); color: var(--bg-surface);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; font-weight: 800;
        }

        .sidebar-divider {
            height: 1px;
            background-color: var(--border-light);
            margin: 0.5rem 0;
            width: 100%;
        }

        .section-title {
            font-size: 0.75rem; color: var(--text-tertiary); font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.05em; 
            margin-bottom: 0.75rem;
        }

        /* Upload Zone - Cleaner */
        .upload-zone {
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-lg);
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-body);
            color: var(--text-secondary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .upload-zone:hover { border-color: var(--text-tertiary); background: var(--bg-subtle); color: var(--text-primary); }
        .upload-zone.active { border-color: var(--accent); background: var(--bg-subtle); transform: scale(0.98); }

        .stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; margin-bottom: 0.75rem; }
        .stat-val { font-weight: 600; font-variant-numeric: tabular-nums; color: var(--text-primary); background: var(--bg-subtle); padding: 2px 8px; border-radius: 6px; font-size: 0.85rem;}

        .btn-text {
            background: none; border: none; padding: 0.75rem 1rem;
            color: var(--text-secondary); cursor: pointer;
            font-size: 0.9rem; display: flex; align-items: center; gap: 0.75rem;
            transition: var(--transition); width: 100%; text-align: right;
            border-radius: var(--radius-md); font-family: inherit; font-weight: 500;
        }
        .btn-text:hover { background: var(--bg-subtle); color: var(--text-primary); }
        .btn-text.danger { color: var(--danger); }
        .btn-text.danger:hover { background: #FEF2F2; color: var(--danger); }
        [data-theme="dark"] .btn-text.danger:hover { background: rgba(239, 68, 68, 0.1); }

        /* --- 5. Workspace & Header (Balanced) --- */
        .workspace {
            display: flex; flex-direction: column;
            height: 100%; overflow: hidden;
            position: relative;
            background: var(--bg-body);
        }

        .top-nav {
            height: var(--header-h);
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-light);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2rem;
            gap: 1rem;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            z-index: 20;
        }

        /* Unified Controls Height & Look */
        .input-group { flex: 1; max-width: 500px; position: relative; }
        
        .input-clean {
            width: 100%; height: var(--control-h);
            padding: 0 1rem;
            border: 1px solid var(--border-light); 
            border-radius: var(--radius-lg);
            background: var(--bg-body); 
            color: var(--text-primary);
            font-size: 0.95rem; font-family: inherit;
            transition: var(--transition);
        }
        .input-clean:focus { 
            border-color: var(--accent); 
            background: var(--bg-surface); 
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .input-clean:focus { box-shadow: 0 0 0 3px rgba(255,255,255,0.05); }

        .btn-icon, .btn-primary {
            height: var(--control-h);
            display: flex; align-items: center; justify-content: center;
            border-radius: var(--radius-lg);
            transition: var(--transition);
            cursor: pointer;
            font-family: inherit;
            border: 1px solid transparent;
        }

        .btn-icon {
            width: var(--control-h); /* Square 44x44 */
            background: var(--bg-body);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
        }
        .btn-icon:hover { 
            border-color: var(--border-hover); 
            color: var(--text-primary); 
            background: var(--bg-surface);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent); color: var(--bg-surface);
            padding: 0 1.25rem;
            font-size: 0.9rem; font-weight: 500;
            gap: 0.5rem;
        }
        .btn-primary:hover { 
            background: var(--accent-hover); 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .btn-primary { color: #000; } /* Text logic flip for contrast */

        /* Search Input Styling */
        #searchInput { display: none; width: 220px; }
        
        /* CSS Inline Media Fix */
        .btn-label-responsive { display: none; }
        @media (min-width: 600px) {
            .btn-label-responsive { display: inline; }
        }
        @media (min-width: 900px) {
            #searchInput { display: block; }
        }

        /* --- 6. Grid & Cards (Polished) --- */
        .content-scroll { 
            flex: 1; overflow-y: auto; padding: 2rem; 
            scroll-behavior: smooth;
        }

        .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding-bottom: 4rem;
        }

        .font-card {
            background: var(--bg-surface);
            border: 1px solid rgba(0,0,0,0.02); /* Very subtle border */
            border-radius: var(--radius-xl);
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            transition: var(--transition);
            box-shadow: var(--shadow-card);
        }
        
        .font-card:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-card-hover);
        }

        .card-preview {
            height: 160px; /* Taller preview */
            display: flex; align-items: center; justify-content: center;
            padding: 1.5rem;
            font-size: 2rem;
            color: var(--text-primary);
            background: var(--bg-surface); /* Seamless with card */
            border-bottom: 1px solid var(--bg-subtle);
            overflow: hidden; text-align: center;
            position: relative;
        }

        /* Subtle grid pattern for preview background - Optional Polish */
        .card-preview::before {
            content: ''; position: absolute; inset: 0;
            background-image: radial-gradient(var(--border-light) 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.3; pointer-events: none;
        }

        .card-meta {
            padding: 1rem 1.25rem;
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-surface);
            gap: 0.75rem;
        }

        .font-name {
            font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); /* Softer color */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;
            cursor: pointer; transition: color 0.2s;
        }
        .font-name:hover { color: var(--text-primary); }

        .tag-input {
            border: none; background: var(--bg-subtle);
            font-size: 0.75rem; color: var(--text-secondary);
            text-align: center; width: 80px;
            padding: 4px 8px; border-radius: 99px; /* Pill shape */
            transition: var(--transition); font-family: inherit;
        }
        .tag-input:focus { background: var(--bg-body); color: var(--text-primary); width: 100px; ring: 1px solid var(--accent); }
        .tag-input::placeholder { color: var(--text-tertiary); }

        /* Delete Button - Clean Floating */
        .btn-delete-card {
            position: absolute; top: 10px; left: 10px;
            width: 32px; height: 32px; border-radius: 10px;
            background: rgba(255,255,255,0.9); 
            border: 1px solid rgba(0,0,0,0.05);
            color: var(--danger); display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transform: scale(0.9);
            transition: var(--transition);
            z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .btn-delete-card { background: rgba(30,30,30,0.9); border-color: rgba(255,255,255,0.1); }
        
        .font-card:hover .btn-delete-card { opacity: 1; transform: scale(1); }
        .btn-delete-card:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* --- 7. Feedback UI --- */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px; z-index: 100;
            background: transparent; pointer-events: none;
        }
        .loader-bar {
            height: 100%; background: var(--accent); width: 0; transition: width 0.2s;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .loader-text {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--bg-surface); color: var(--text-primary);
            padding: 6px 16px; border-radius: 99px; font-size: 0.8rem; font-weight: 600;
            z-index: 101; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-light);
        }
        .loader-text.active { display: block; animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        .toast {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--accent); color: var(--bg-surface);
            padding: 0.75rem 1.5rem; border-radius: 99px; font-size: 0.9rem; font-weight: 500;
            opacity: 0; transition: var(--transition); pointer-events: none; z-index: 200;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; gap: 0.75rem;
        }
        [data-theme="dark"] .toast { color: #000; } /* Contrast fix */
        .toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }

        @keyframes slideDown { from { transform: translateX(-50%) translateY(-10px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

        /* Mobile */
        .mobile-btn { display: none; }
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            opacity: 0; pointer-events: none; transition: var(--transition); z-index: 40;
            backdrop-filter: blur(4px);
        }
        .overlay.active { opacity: 1; pointer-events: auto; }

        @media (max-width: 900px) {
            .app-shell { grid-template-columns: 1fr; }
            .sidebar {
                position: fixed; top: 0; right: 0; bottom: 0; width: 280px;
                transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                box-shadow: -10px 0 30px rgba(0,0,0,0.15);
                padding-top: 2rem;
            }
            .sidebar.active { transform: translateX(0); }
            .mobile-btn { display: flex; }
            .top-nav { padding: 0 1rem; }
            .content-scroll { padding: 1rem; }
        }

        /* --- 8. Print Engine (Preserved Logic) --- */
        @media print {
            @page { margin: 10mm; size: auto; }
            body, html { background: white !important; height: auto; overflow: visible; color: #000 !important; }
            .app-shell, .toast, .loader, .loader-text { display: none !important; }
            #printContainer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            table { width: 100%; border-collapse: collapse; font-family: 'IBM Plex Sans Arabic', sans-serif; table-layout: fixed; }
            th, td { border: 1px solid #000 !important; padding: 10px; text-align: right; font-size: 12px; color: #000 !important; background: white !important; page-break-inside: avoid; }
            th { border-bottom: 2px solid #000 !important; font-weight: bold; background: #f0f0f0 !important; }
            tr { page-break-inside: avoid; }
        }
        #printContainer { display: none; }
    </style>
</head>
<body data-theme="light">

<div class="loader"><div class="loader-bar" id="progressFill"></div></div>
<div class="loader-text" id="loaderText">0%</div>
<div class="overlay" id="overlay" onclick="App.toggleSidebar()"></div>

<div class="app-shell">
    <aside class="sidebar" id="sidebar">
        <a href="#" class="brand">
            <div class="brand-icon">F</div>
            <span>Font Scope Pro</span>
        </a>

        <!-- Upload -->
        <div>
            <div class="section-title">إضافة خطوط</div>
            <label class="upload-zone" id="dropZone">
                <i data-lucide="upload-cloud" width="28" style="margin-bottom:0.75rem; opacity:0.8;"></i>
                <div style="font-weight:600; font-size:0.9rem;">اختر ملفات</div>
                <div style="font-size:0.8rem; opacity:0.6; margin-top:0.25rem;">TTF, OTF, WOFF</div>
                <input type="file" id="fileInput" multiple accept=".ttf,.otf,.woff2,.woff" hidden>
            </label>
        </div>

        <div class="sidebar-divider"></div>

        <!-- Stats -->
        <div>
            <div class="section-title">الإحصائيات</div>
            <div class="stat-row">
                <span style="color:var(--text-secondary)">الإجمالي</span>
                <span class="stat-val" id="totalFonts">0</span>
            </div>
            <div class="stat-row">
                <span style="color:var(--text-secondary)">المعروض</span>
                <span class="stat-val" id="pageFonts">0</span>
            </div>
        </div>

        <!-- Actions -->
        <div style="margin-top:auto; display:flex; flex-direction:column; gap:0.5rem;">
            <button onclick="App.clearAll()" class="btn-text danger">
                <i data-lucide="trash-2" width="16"></i> حذف المكتبة كاملة
            </button>
            <div style="font-size:0.7rem; color:var(--text-tertiary); margin-top:1rem; text-align:center;">
                V4.0 Stable
            </div>
        </div>
    </aside>

    <main class="workspace">
        <header class="top-nav">
            <button class="btn-icon mobile-btn" onclick="App.toggleSidebar()">
                <i data-lucide="menu" width="20"></i>
            </button>
            
            <div class="input-group">
                <input type="text" id="previewInput" class="input-clean" placeholder="نص المعاينة..." value="سبحان الله وبحمده">
            </div>

            <div style="display:flex; gap:0.75rem; align-items:center;">
                <input type="search" id="searchInput" class="input-clean" placeholder="بحث...">
                
                <button onclick="App.exportPDF()" class="btn-primary" title="تصدير تقرير">
                    <i data-lucide="printer" width="18"></i>
                    <span class="btn-label-responsive">تصدير</span>
                </button>
                
                <button onclick="App.toggleTheme()" class="btn-icon" title="المظهر">
                    <i data-lucide="moon" id="themeIcon" width="20"></i>
                </button>
            </div>
        </header>

        <div class="content-scroll" id="scrollContainer">
            <div id="fontGrid" class="font-grid"></div>
        </div>
    </main>
</div>

<div id="toast" class="toast">
    <i data-lucide="check-circle" width="20"></i>
    <span id="toastMsg">تمت العملية</span>
</div>

<div id="printContainer">
    <table id="printTable">
        <thead>
            <tr>
                <th style="width:50%">المعاينة</th>
                <th style="width:30%">اسم الخط</th>
                <th style="width:20%">الوسم</th>
            </tr>
        </thead>
        <tbody id="printBody"></tbody>
    </table>
</div>

<script>
/**
 * Font Scope Pro - V4.0 Stable (Secured)
 * Limited to 500 Fonts
 */

const App = (function() {
    // --- State & Optimization ---
    const STATE = {
        db: null,
        fonts: [],
        filtered: [],
        previewText: "سبحان الله وبحمده",
        search: "",
        loadedFonts: new Set(),
        objectUrls: new Map(),
        renderedMap: new Map(),
        previewNodes: [],
        isProcessing: false
    };

    // HARD LIMITS
    const MAX_FONTS = 500;
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

    // State Hardening
    Object.seal(STATE);
    Object.freeze(STATE.objectUrls);
    Object.freeze(STATE.loadedFonts);

    // --- DOM Cache ---
    const DOM = {
        grid: document.getElementById('fontGrid'),
        preview: document.getElementById('previewInput'),
        search: document.getElementById('searchInput'),
        total: document.getElementById('totalFonts'),
        shown: document.getElementById('pageFonts'),
        progress: document.getElementById('progressFill'),
        loaderText: document.getElementById('loaderText'),
        sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('overlay'),
        fileInput: document.getElementById('fileInput'),
        dropZone: document.getElementById('dropZone')
    };

    // --- 1. Storage Layer ---
    const DB = {
        init: () => new Promise((resolve, reject) => {
            const req = indexedDB.open("FontScope_V8", 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("fonts")) {
                    db.createObjectStore("fonts", { keyPath: "fileName" });
                }
            };
            req.onsuccess = e => { STATE.db = e.target.result; resolve(); };
            req.onerror = e => { console.warn("DB Error", e); reject(e); };
        }),
        getAll: () => new Promise((resolve, reject) => {
            if (!STATE.db) return resolve([]);
            const tx = STATE.db.transaction("fonts", "readonly");
            const store = tx.objectStore("fonts");
            const req = store.getAll();
            req.onerror = (e) => { console.warn("DB getAll error", e); reject(e); };
            tx.oncomplete = () => { resolve(Array.isArray(req.result) ? req.result : []); };
        }),
        put: (item) => new Promise((resolve, reject) => {
            const tx = STATE.db.transaction("fonts", "readwrite");
            const req = tx.objectStore("fonts").put(item);
            req.onsuccess = resolve;
            req.onerror = reject;
        }),
        delete: (key) => new Promise((resolve, reject) => {
            if (!STATE.db) { reject("DB not init"); return; }
            const tx = STATE.db.transaction("fonts", "readwrite");
            const store = tx.objectStore("fonts");
            const req = store.delete(key);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
            req.onerror = (e) => reject(e);
        }),
        clear: () => new Promise((resolve, reject) => {
            if (!STATE.db) { reject("DB not init"); return; }
            const tx = STATE.db.transaction("fonts", "readwrite");
            const store = tx.objectStore("fonts");
            const req = store.clear();
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
            req.onerror = (e) => reject(e);
        })
    };

    // --- 2. Security & Single Style System ---
    const MasterStyle = {
        sheet: null,
        init: () => {
            if (document.getElementById('fsp-styles')) return;
            const style = document.createElement('style');
            style.id = 'fsp-styles';
            document.head.appendChild(style);
            MasterStyle.sheet = style.sheet;
        },
        insert: (rule) => {
            try {
                MasterStyle.sheet.insertRule(rule, MasterStyle.sheet.cssRules.length);
            } catch (e) { console.warn("CSS Inject Warn", e); }
        },
        remove: (fontId) => {
            const rules = MasterStyle.sheet.cssRules;
            for (let i = 0; i < rules.length; i++) {
                if (rules[i].cssText.includes(`font-family: "${fontId}"`)) {
                    MasterStyle.sheet.deleteRule(i);
                    return; 
                }
            }
        },
        clear: () => {
            while (MasterStyle.sheet.cssRules.length > 0) {
                MasterStyle.sheet.deleteRule(0);
            }
        }
    };

    const Security = {
        safeFontId: (fileName, blob) => {
            const size = blob instanceof Blob ? blob.size : 0;
            const type = blob instanceof Blob ? (blob.type || 'na') : 'na';
            const base = fileName + "_" + size + "_" + type;
            const encodedBase = unescape(encodeURIComponent(base));
            const safeStr = fileName.replace(/[^a-zA-Z0-9]/g, '_');
            const hash = btoa(encodedBase).replace(/=/g, '').slice(0, 8);
            return "f_" + safeStr.slice(0, 20) + "_" + hash;
        },
        sanitizeTag: (str) => {
            if (!str) return '';
            return str.trim().slice(0, 40)
                      .replace(/[\u0000-\u001F\u007F-\u009F\u200E\u200F\u202A-\u202E]/g, '');
        },
        create: (tag, className, textContent) => {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (textContent) el.textContent = textContent;
            return el;
        },
        // --- Added: Magic Bytes Check ---
        checkSignature: (file) => {
            return new Promise((resolve) => {
                const slice = file.slice(0, 4);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const view = new DataView(e.target.result);
                        if (view.byteLength < 4) return resolve(false);
                        const magic = view.getUint32(0, false); // Big-endian
                        // TTF=00010000, OTF=4F54544F, WOFF=774F4646, WOFF2=774F4632
                        const valid = [0x00010000, 0x4F54544F, 0x774F4646, 0x774F4632].includes(magic);
                        resolve(valid);
                    } catch (err) { resolve(false); }
                };
                reader.onerror = () => resolve(false);
                reader.readAsArrayBuffer(slice);
            });
        }
    };

    // --- 3. Core Logic ---
    async function init() {
        MasterStyle.init();
        const theme = localStorage.getItem('theme') || 'light';
        setTheme(theme);

        try {
            await DB.init();
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => loadFonts());
            } else {
                setTimeout(loadFonts, 10);
            }
        } catch (e) {
            console.error(e);
            toast("فشل تحميل البيانات", "error");
        }
        
        setupListeners();
        lucide.createIcons();
    }

    async function loadFonts() {
        STATE.fonts = await DB.getAll();

        DOM.grid.innerHTML = '';
        STATE.renderedMap.clear();
        STATE.previewNodes = [];
        
        MasterStyle.clear();
        STATE.loadedFonts.clear();

        filter();
    }

    function getFontUrl(fileName, data) {
        if (STATE.objectUrls.has(fileName)) return STATE.objectUrls.get(fileName);
        let url;
        if (data instanceof Blob) url = URL.createObjectURL(data);
        else if (typeof data === 'string') url = data;
        else return null;
        STATE.objectUrls.set(fileName, url);
        return url;
    }

    function injectFontFace(fileName, data) {
        const fontId = Security.safeFontId(fileName, data);
        if (STATE.loadedFonts.has(fontId)) return fontId;

        const url = getFontUrl(fileName, data);
        if (!url) return null;

        const rule = `@font-face { font-family: "${fontId}"; src: url("${url}"); font-display: swap; }`;
        MasterStyle.insert(rule);
        
        STATE.loadedFonts.add(fontId);
        return fontId;
    }

    function filter() {
        const q = STATE.search.toLowerCase();
        STATE.filtered = STATE.fonts.filter(f => 
            (f.fileName && f.fileName.toLowerCase().includes(q)) || 
            (f.userTag && f.userTag.toLowerCase().includes(q))
        );
        render();
    }

    // --- 4. Rendering ---
    function render() {
        DOM.total.textContent = STATE.fonts.length;
        DOM.shown.textContent = STATE.filtered.length;

        const validKeys = new Set(STATE.filtered.map(f => f.fileName));

        // Cleanup DOM
        for (const [fileName, entry] of STATE.renderedMap) {
            if (!validKeys.has(fileName)) {
                entry.card.remove();
                STATE.renderedMap.delete(fileName);
            }
        }

        let iconsDirty = false;

        if (STATE.filtered.length === 0) {
            if (!document.getElementById('emptyState')) {
                const empty = Security.create('div', '', '');
                empty.id = 'emptyState';
                empty.style.cssText = "grid-column:1/-1; text-align:center; padding:4rem; color:var(--text-tertiary);";
                
                const icon = Security.create('i');
                icon.setAttribute('data-lucide', 'ghost');
                icon.setAttribute('width', '32');
                icon.style.cssText = "opacity:0.5; margin-bottom:1rem;";
                
                const text = Security.create('p', '', 'لا توجد خطوط');
                
                empty.appendChild(icon);
                empty.appendChild(text);
                DOM.grid.appendChild(empty);
                iconsDirty = true;
            }
        } else {
            const empty = document.getElementById('emptyState');
            if (empty) empty.remove();
        }

        // Reset previewNodes
        STATE.previewNodes.length = 0;

        STATE.filtered.forEach((font, index) => {
            let entry = STATE.renderedMap.get(font.fileName);

            if (!entry) {
                const fontId = injectFontFace(font.fileName, font.data);
                if (!fontId) return;

                const card = Security.create('div', 'font-card');
                
                // --- Single Delete Button Implementation ---
                const btnDelete = Security.create('button', 'btn-delete-card');
                btnDelete.title = "حذف الخط";
                const iconDel = Security.create('i');
                iconDel.setAttribute('data-lucide', 'trash-2');
                iconDel.setAttribute('width', '14');
                btnDelete.appendChild(iconDel);
                
                btnDelete.onclick = (e) => {
                    e.stopPropagation(); // Stop card click
                    deleteSingleFont(font.fileName);
                };
                card.appendChild(btnDelete);
                // -------------------------------------------

                const preview = Security.create('div', 'card-preview', STATE.previewText);
                preview.style.fontFamily = `"${fontId}"`;
                card.appendChild(preview);

                const meta = Security.create('div', 'card-meta');
                const nameEl = Security.create('div', 'font-name', font.fileName.replace(/\.[^/.]+$/, ""));
                nameEl.onclick = () => copyText(nameEl.textContent);
                nameEl.title = font.fileName;

                const tagInput = Security.create('input', 'tag-input');
                tagInput.placeholder = "+وسم";
                tagInput.value = font.userTag || '';
                tagInput.onchange = (e) => updateTag(font.fileName, e.target.value);

                meta.appendChild(nameEl);
                meta.appendChild(tagInput);
                card.appendChild(meta);

                entry = { card, preview };
                STATE.renderedMap.set(font.fileName, entry);
                
                iconsDirty = true; 
            }

            const currentChild = DOM.grid.children[index];
            if (currentChild !== entry.card) {
                if (index >= DOM.grid.children.length) {
                    DOM.grid.appendChild(entry.card);
                } else {
                    DOM.grid.insertBefore(entry.card, currentChild);
                }
            }
            
            STATE.previewNodes.push(entry.preview);
        });

        if (iconsDirty) {
            lucide.createIcons({ root: DOM.grid });
        }
    }

    // --- 5. Actions (Secured) ---
    async function handleUpload(files) {
        if (STATE.isProcessing) return;
        const validExtensions = ['.ttf', '.otf', '.woff', '.woff2'];
        const validFiles = Array.from(files).filter(f => validExtensions.some(ext => f.name.toLowerCase().endsWith(ext)));

        if (!validFiles.length) return toast("صيغة الملف غير مدعومة", "error");

        // --- LIMIT CHECK ---
        if (STATE.fonts.length + validFiles.length > MAX_FONTS) {
            return toast(`الحد الأقصى ${MAX_FONTS} خط. يرجى حذف بعض الخطوط أولاً.`, "error");
        }

        // --- STORAGE OVERFLOW PROTECTION ---
        if (navigator.storage && navigator.storage.estimate) {
            try {
                const { quota, usage } = await navigator.storage.estimate();
                const totalUploadSize = validFiles.reduce((acc, f) => acc + f.size, 0);
                if ((quota - usage) < totalUploadSize) {
                    return toast("لا توجد مساحة تخزين كافية", "error");
                }
            } catch (err) { console.warn("Storage estimate failed", err); }
        }

        STATE.isProcessing = true;
        updateProgress(0, true);

        let successCount = 0;
        const total = validFiles.length;

        for (let i = 0; i < total; i++) {
            const file = validFiles[i];
            
            // 1. Check Size
            if (file.size > MAX_FILE_SIZE) {
                toast(`تجاوز الحجم المسموح (50MB): ${file.name}`, "error");
                updateProgress(((i + 1) / total) * 100, true);
                continue;
            }

            try {
                // 2. Check Magic Bytes (Signature)
                const isValidSignature = await Security.checkSignature(file);
                if (!isValidSignature) {
                    toast(`ملف غير صالح كخط: ${file.name}`, "error");
                    updateProgress(((i + 1) / total) * 100, true);
                    continue;
                }

                // 3. Read & Save
                const exists = STATE.fonts.find(f => f.fileName === file.name);
                const tag = exists ? exists.userTag : '';
                const buffer = await readFileBuffer(file); // Wrapped in try/catch
                const blob = new Blob([buffer], { type: file.type || 'application/octet-stream' });
                
                await DB.put({ fileName: file.name, data: blob, userTag: tag });
                successCount++;

            } catch (e) { 
                console.warn(e);
                toast(`فشل قراءة الملف: ${file.name}`, "error");
            }

            updateProgress(((i + 1) / total) * 100, true);
            
            // 4. Anti-Freeze
            await new Promise(r => requestAnimationFrame(r));
        }

        setTimeout(() => {
            updateProgress(100, false);
            STATE.isProcessing = false;
            loadFonts();
            if (successCount > 0) toast(`تم رفع ${successCount} خط بنجاح`);
        }, 600);
    }

    function readFileBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    // --- Single Font Deletion ---
    function deleteSingleFont(fileName) {
        if (!confirm(`حذف الخط "${fileName}"؟`)) return;

        DB.delete(fileName).then(() => {
            // Update State
            STATE.fonts = STATE.fonts.filter(f => f.fileName !== fileName);
            STATE.filtered = STATE.filtered.filter(f => f.fileName !== fileName);

            // Memory Clean
            if (STATE.objectUrls.has(fileName)) {
                URL.revokeObjectURL(STATE.objectUrls.get(fileName));
                STATE.objectUrls.delete(fileName);
            }

            // DOM Cleanup (Fast removal)
            const entry = STATE.renderedMap.get(fileName);
            if (entry) {
                entry.card.remove();
                STATE.renderedMap.delete(fileName);
            }

            // Re-sync
            filter();
            toast("تم حذف الخط");

        }).catch(e => {
            toast("فشل الحذف", "error");
            console.warn(e);
        });
    }

    // --- Clear All ---
    function clearAll() {
        if (!confirm("حذف المكتبة بالكامل؟")) return;
        if (STATE.isProcessing) return;

        STATE.isProcessing = true;
        
        DB.clear()
            .then(() => {
                STATE.objectUrls.forEach(url => URL.revokeObjectURL(url));
                STATE.objectUrls.clear();
                return loadFonts();
            })
            .then(() => {
                toast("تم تنظيف المكتبة");
            })
            .catch(e => {
                console.warn("Clear failed", e);
                toast("فشل التنظيف", "error");
            })
            .finally(() => {
                STATE.isProcessing = false;
            });
    }

    function updateTag(fileName, rawTag) {
        const tag = Security.sanitizeTag(rawTag);
        const font = STATE.fonts.find(f => f.fileName === fileName);
        if (font) { font.userTag = tag; DB.put(font); }
    }

    // --- 6. Export ---
    async function exportPDF() {
        if (STATE.search && STATE.filtered.length === 0) {
            return toast("لا توجد نتائج للتصدير", "error");
        }
        if (!STATE.fonts.length) return toast("لا توجد بيانات", "error");

        STATE.isProcessing = true;
        updateProgress(0, true);

        const tbody = document.getElementById('printBody');
        tbody.innerHTML = '';
        const list = STATE.filtered.length ? STATE.filtered : STATE.fonts;
        const total = list.length;
        const CHUNK_SIZE = 20;

        for (let i = 0; i < total; i += CHUNK_SIZE) {
            const chunk = list.slice(i, i + CHUNK_SIZE);
            const fragment = document.createDocumentFragment();

            chunk.forEach(font => {
                const fontId = injectFontFace(font.fileName, font.data);
                if (!fontId) return;
                const tr = document.createElement('tr');
                const tdPrev = document.createElement('td');
                tdPrev.textContent = STATE.previewText;
                tdPrev.style.fontFamily = `"${fontId}"`;
                tdPrev.style.fontSize = "20px";
                const tdName = document.createElement('td');
                tdName.textContent = font.fileName;
                const tdTag = document.createElement('td');
                tdTag.textContent = font.userTag || '-';
                tr.append(tdPrev, tdName, tdTag);
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
            updateProgress(Math.min(((i + CHUNK_SIZE) / total) * 100, 100), true);
            await new Promise(r => requestAnimationFrame(r));
        }

        setTimeout(() => {
            updateProgress(100, false);
            STATE.isProcessing = false;
            window.print();
        }, 500);
    }

    // --- 7. Utils & Events ---
    function updateProgress(pct, show) {
        DOM.progress.style.width = show ? `${pct}%` : '0';
        if (show) { DOM.loaderText.textContent = `${Math.floor(pct)}%`; DOM.loaderText.classList.add('active'); }
        else { setTimeout(() => DOM.loaderText.classList.remove('active'), 300); }
    }

    function toast(msg, type = 'success') {
        document.getElementById('toastMsg').textContent = msg;
        const t = document.getElementById('toast');
        t.classList.add('active');
        t.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--accent)';
        setTimeout(() => t.classList.remove('active'), 3000);
    }

    function copyText(text) { 
        navigator.clipboard.writeText(text)
            .then(() => toast("تم نسخ الاسم"))
            .catch(e => console.warn("Clipboard failed", e)); 
    }
    
    function setTheme(t) {
        document.body.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.getElementById('themeIcon').setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');
        lucide.createIcons();
    }

    function setupListeners() {
        let searchTimeout;
        DOM.search.addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                STATE.search = e.target.value;
                filter();
            }, 100);
        });
        
        let previewTimeout;
        DOM.preview.addEventListener('input', e => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                STATE.previewText = e.target.value || "نص افتراضي";
                for (let i = 0, len = STATE.previewNodes.length; i < len; i++) {
                    STATE.previewNodes[i].textContent = STATE.previewText;
                }
            }, 100);
        });

        DOM.fileInput.onchange = e => handleUpload(e.target.files);
        DOM.dropZone.ondragover = e => { e.preventDefault(); DOM.dropZone.classList.add('active'); };
        DOM.dropZone.ondragleave = e => { e.preventDefault(); DOM.dropZone.classList.remove('active'); };
        DOM.dropZone.ondrop = e => { e.preventDefault(); DOM.dropZone.classList.remove('active'); handleUpload(e.dataTransfer.files); };
    }

    return {
        init, exportPDF, clearAll,
        toggleTheme: () => setTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'),
        toggleSidebar: () => { DOM.sidebar.classList.toggle('active'); DOM.overlay.classList.toggle('active'); }
    };
})();

window.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>